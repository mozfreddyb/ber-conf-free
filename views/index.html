<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name=viewport content="width=device-width, initial-scale=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>

  <script src="js/jquery.min.js" type="text/javascript"></script>
  <script src="js/moment.js" type="text/javascript"></script>
  <script src="js/index.js" type="text/javascript"></script>

  <script src="js/react-with-addons-0.8.0.js"></script>
  <script src="js/JSXTransformer-0.8.0.js"></script>

  <link rel="stylesheet" href="css/index.css">

</head>
<body>

  <div class="container-fluid">

    <h2 class="pull-left" id="time"></h2>
    <h2 class="pull-right" id="date"></h2>

    <div class="clearfix"></div>

    <div id="content"></div>

    <h2 class="text-center"><%= title %></h2>

    <div id="overlay">
      <button id="fullscreen">Fullscreen (f)</button>
      <script type="text/javascript">
        window.addEventListener('mozfullscreenchange', function() {
          var button = document.querySelector('#fullscreen');
          if (isFullScreen) {
            button.textContent = 'Leave Fullscreen (f)';
          } else {
            button.textContent = 'Fullscreen (f)';
          }
        });
      </script>
    </div>

  </div>

  <script type="text/jsx">
    /**
     * @jsx React.DOM
     */
    // The above declaration must remain intact at the top of the script.
    // Your code here
    var BUSY_FUZZ = 5;

    var Dudes = React.createClass({
      render : function () {
        var dudes = new Array(this.props.size);
        for (var i = 0; i < this.props.size; i += 1) {
          dudes.push(<span key={i} className='glyphicon glyphicon-user pull-right'></span>);
        }
        return (
          <span className="dudes">{dudes}</span>
        );
      }
    });
    var Room = React.createClass({
      freebusy: function() {
        var now = moment();
        var isBusy = false,
            willBeBusy = false,
            moreThanOneHour = true,
            withInFuzzOfEnd = false,
            withInFuzzOfStart = false,
            fbs = this.props.room.freebusy.sort(function (a, b) { return moment(a.end) > moment(b.end); });

        var text = "", when = "";
        var fb = fbs.find(function (fb) { return now.isBefore(fb.end); });

        if (fb) {
          willBeBusy = (now.isBefore(fb.end));
          isBusy = (now.isAfter(fb.start) && willBeBusy);
          moreThanOneHour = (moment(fb.end).diff() > 60 * 60 * 1000),
          withInFuzzOfEnd = (moment(fb.end).diff() < BUSY_FUZZ * 60 * 1000),
          withInFuzzOfStart = (moment(fb.start).diff() < BUSY_FUZZ * 60 * 1000);


          if (isBusy) {
            text = "free";
            when = (moreThanOneHour) ? moment(fb.end).format('h:mma') : moment(fb.end).fromNow();
          } else if (willBeBusy) {
            text = "booked";
            when = (moreThanOneHour) ? moment(fb.start).format('h:mma') : moment(fb.start).fromNow();
          }
          text += (moreThanOneHour) ? " at" : " in";

        } else {
          isBusy = false
        }

        var cxs = {
          'room' : true,
          'room-vidyo' : this.props.room.vidyo,
          'room-free' : (!isBusy),
          'room-busy' : isBusy,
          'room-free-soon' : (isBusy && withInFuzzOfEnd),
          'room-busy-soon' : (!isBusy && withInFuzzOfStart),
          'room-busy-later' : (!isBusy && willBeBusy)
        };
        cxs['room-neighborhood-' + this.props.room.neighborhood] = true;
        cxs['room-size-' + this.props.room.size] = true;
        return { classes : React.addons.classSet(cxs), text : text, when : when };
      },
      render : function () {

        if (!this.props.room) {
          return <div/>;
        }

        var freebusy = this.freebusy();

        // Terrible hack :(
        // The random 20 value is equal to the px of margin between the small boxes
        var height = (this.props.room.size > 2) ? ($(window).height() + 20) : ($(window).height());
        // Here we just grab the padding we are aware of and adjust for it
        var padding = $("body").innerHeight() - $("body").height();
        height -= (padding * 2) + $("h2").height() * 2.2;
        // For the large room we wanted to make it take the whole height
        // All other rooms want only half the height
        height = (this.props.room.size > 2) ? height : height / 2;

        var divStyle = {
          height : height
        };

        return (
          <div style={divStyle} className={freebusy.classes}>
            <div className="name">{this.props.room.name}</div>
            <span className="glyphicon glyphicon-ok"></span>
            <div className="fb">
              <div>{freebusy.text}</div>
              <div>{freebusy.when}</div>
              <div className="attrs">
                <Dudes size={this.props.room.size} />
                <span className={(this.props.room.vidyo) ? 'pull-left glyphicon glyphicon-facetime-video' : ''} ></span>
              </div>
            </div>
          </div>
        );
      }
    });
    var Rooms = React.createClass({
      loadRoomsFromServer: function() {
        $.ajax({
          url: "/api/rooms",
          success: function(data) {
            this.setState(data);
          }.bind(this)
        });
      },
      getInitialState: function() {
        return { rooms : [] };
      },
      componentWillMount: function() {
        this.loadRoomsFromServer();
        setInterval(this.loadRoomsFromServer, 60 * 1000);
      },
      render: function() {
        var findRoom = function(id) {
          return this.state.rooms.find(function (room) { return room.id == id; });
        }.bind(this);

        return (
          <div className="row">
            <div className="col-md-2">
              <Room room={findRoom("201")} />
            </div>
            <div className="col-md-2">
              <Room room={findRoom("205")} />
            </div>
            <div className="col-md-2">
              <Room room={findRoom("210")} />
              // Foosball table room
            </div>
          </div>
        );
      }
    });
    React.initializeTouchEvents(true);
    triggerLayout();

    function triggerLayout() {
      React.renderComponent(
        <Rooms />,
        document.getElementById('content')
      );
    }
  </script>
</body>
</html>
